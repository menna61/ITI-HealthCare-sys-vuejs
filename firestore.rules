rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow limited read on patients and doctors for anonymous email existence check
    match /patients/{userId} {
      allow read: if true; // Allow anonymous read, but code limits to 1 result
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Allow patients to read their own transactions
      match /transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    match /doctors/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Admin wallet - allow authenticated doctors to write (for commissions)
    // and admins to read
    match /admin/wallet {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      
      match /transactions/{transactionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    // Bookings - allow read/write for authenticated users
    match /bookings/{bookingId} {
      allow read, write: if request.auth != null;
      
      // Medical details subcollection
      match /medicalDetails/{detailId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null;
    }
    
    // Other collections require auth
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
